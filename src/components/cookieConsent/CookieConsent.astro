---
// CookieConsent.astro - Minimalistisches Cookie-Banner nur für Marketing-Cookies
export interface Props {
    privacyPolicyUrl?: string;
}

const { privacyPolicyUrl = "/privacy-policy" } = Astro.props;
---

<!-- Cookie Consent Banner -->
<div
    id="cookie-consent-banner"
    class="fixed bottom-4 right-4 max-w-sm w-full sm:w-96 bg-neutral-800 shadow-2xl border border-neutral-700 rounded-lg p-4 z-50 transform translate-x-full transition-transform duration-300 ease-in-out"
    aria-live="polite"
    aria-label="Cookie-Einstellungen"
>
    <div class="space-y-3">
        <div class="flex items-start justify-between">
            <h3 class="text-lg font-bold">Cookie-Einstellungen</h3>
            <button
                id="close-banner"
                class="text-neutral-400 hover:text-neutral-300 ml-2"
            >
                <i class="ti ti-x text-lg"></i>
            </button>
        </div>

        <div class="text-sm space-y-2">
            <p>
                Wir verwenden ausschließlich technisch notwendige Cookies für
                den Betrieb der Website. Externe Medieninhalte (Spotify,
                YouTube) werden erst nach Ihrer Zustimmung geladen.
            </p>
            <p class="text-xs text-neutral-400">
                Mit einem Klick auf "Externe Medien erlauben" stimmen Sie zu,
                dass Drittanbieter wie Spotify und YouTube Cookies setzen und
                Daten über Ihre Nutzung sammeln können.
            </p>
        </div>

        <div class="flex flex-col gap-2">
            <button
                id="accept-media"
                class="px-4 py-2 bg-neutral-700 hover:bg-neutral-600 text-white rounded-lg font-medium text-sm transition-colors duration-200"
            >
                Externe Medien erlauben
            </button>
            <button
                id="reject-media"
                class="px-4 py-2 bg-neutral-700 hover:bg-neutral-600 text-white rounded-lg font-medium text-sm transition-colors duration-200"
            >
                Ablehnen
            </button>
        </div>
        <a
            href={privacyPolicyUrl}
            class="hover:underline text-xs text-neutral-400"
        >
            Datenschutzerklärung
        </a>
    </div>
</div>

<!-- Cookie Settings Button -->
<button
    id="cookie-settings-button"
    class="fixed bottom-4 left-4 w-12 h-12 bg-neutral-700 hover:bg-neutral-600 text-white rounded-full shadow-lg hidden items-center justify-center transition-all duration-200 hover:scale-110 z-40"
    aria-label="Cookie-Einstellungen öffnen"
>
    <i class="ti ti-settings text-2xl"></i>
</button>

<script>
    // Vereinfachter Cookie-Manager nur für externe Medien
    class CookieManager {
        private static CONSENT_COOKIE = "media_consent";
        private static CONSENT_DURATION = 365; // Tage

        static hasMediaConsent(): boolean {
            return this.getCookie(this.CONSENT_COOKIE) === "true";
        }

        static setMediaConsent(allowed: boolean) {
            // Prüfe den aktuellen Zustand vor der Änderung
            const currentConsent = this.hasMediaConsent();
            const consentExists = this.getCookie(this.CONSENT_COOKIE) !== null;

            if (allowed) {
                this.setCookie(
                    this.CONSENT_COOKIE,
                    "true",
                    this.CONSENT_DURATION,
                );
            } else {
                this.deleteCookie(this.CONSENT_COOKIE);
                this.deleteEmbeddedMediaCookies();
                
                // Reload nur wenn Consent von true zu false geändert wird
                // NICHT bei erstmaliger Ablehnung (wenn noch kein Cookie existierte)
                if (consentExists && currentConsent === true) {
                    console.log('Consent wurde von erlaubt zu abgelehnt geändert - Reload wird ausgeführt');
                    this.forceReloadAfterReject();
                } else {
                    console.log('Erstmalige Ablehnung - kein Reload erforderlich');
                }
            }

            // Event für andere Komponenten
            window.dispatchEvent(
                new CustomEvent("mediaConsentUpdate", { detail: { allowed } }),
            );
        }

        static forceReloadAfterReject() {
            console.log('Cookie-Consent widerrufen - Seite wird neu geladen...');
            
            // Zeige Loading-Feedback
            const rejectButton = document.getElementById("reject-media");
            if (rejectButton) {
                rejectButton.textContent = "Lädt...";
                (rejectButton as HTMLButtonElement).disabled = true;
            }
            
            // Kurze Verzögerung für UI-Feedback
            setTimeout(() => {
                window.location.reload();
            }, 500);
        }

        static deleteEmbeddedMediaCookies() {
            // Nur Spotify-Tracking-Cookies (nicht Session-Cookies)
            const spotifyTrackingCookies = [
                "sp_t", // Tracking
                "sp_adid", // Advertising ID
                "sp_ab", // A/B Testing
                "sp_new_ab", // New A/B Testing
                // NICHT: sp_dc, sp_key (Session-Cookies)
            ];

            // Nur YouTube-Embed-spezifische Cookies (nicht Google-Account)
            const youtubeEmbedCookies = [
                "VISITOR_INFO1_LIVE", // YouTube embed tracking
                "YSC", // YouTube session für embeds
                "GPS", // Location (nur für embeds)
                "PREF", // Preferences für embeds
                // NICHT: Accounts-Cookies wie SAPISID, HSID, SID, etc.
            ];

            const embeddedMediaCookies = [
                ...spotifyTrackingCookies,
                ...youtubeEmbedCookies,
            ];

            embeddedMediaCookies.forEach((cookieName) => {
                this.deleteCookie(cookieName);

                // Für verschiedene Domain-Varianten
                document.cookie = `${cookieName}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;domain=.${window.location.hostname};`;
            });

            // Lösche nur embed-spezifische localStorage-Einträge
            this.clearEmbeddedMediaStorage();

            // Entferne geladene iframes
            this.removeEmbeddedMediaIframes();
        }
        static clearEmbeddedMediaStorage() {
            try {
                // localStorage: Nur tracking-spezifische Einträge
                const localStorageKeys = Object.keys(localStorage);
                localStorageKeys.forEach((key) => {
                    // Nur spezifische Tracking-Keys, nicht Account-relevante
                    if (
                        key.startsWith("sp_t") || // Spotify Tracking
                        key.startsWith("sp_ab") || // Spotify A/B Testing
                        key.startsWith("yt-player") || // YouTube Player
                        key.includes("embed") || // Embed-spezifische
                        key.includes("tracking")
                    ) {
                        // Tracking-spezifische
                        localStorage.removeItem(key);
                    }
                });

                // sessionStorage: Nur embed-spezifische
                const sessionStorageKeys = Object.keys(sessionStorage);
                sessionStorageKeys.forEach((key) => {
                    if (
                        key.startsWith("yt-player") ||
                        key.includes("embed") ||
                        key.startsWith("sp_t")
                    ) {
                        sessionStorage.removeItem(key);
                    }
                });
            } catch (e) {
                console.warn("Storage-Bereinigung fehlgeschlagen:", e);
            }
        }

        static removeEmbeddedMediaIframes() {
            // Entferne nur iframes von unserer Seite, nicht separate Browser-Tabs
            const spotifyIframes = document.querySelectorAll('iframe[src*="open.spotify.com/embed"]');
            spotifyIframes.forEach(iframe => {
                iframe.remove();
            });

            const youtubeEmbedIframes = document.querySelectorAll('iframe[src*="youtube.com/embed"], iframe[src*="youtube-nocookie.com/embed"]');
            youtubeEmbedIframes.forEach(iframe => {
                iframe.remove();
            });

            // Setze Player-UI zurück
            const spotifyContainers = document.querySelectorAll('.spotify-iframe-container');
            spotifyContainers.forEach(container => {
                container.innerHTML = '';
                container.classList.add('hidden');
            });

            const spotifyPlaceholders = document.querySelectorAll('.spotify-placeholder');
            spotifyPlaceholders.forEach(placeholder => {
                placeholder.classList.remove('hidden');
            });
        }

        static getCookie(name: string): string | null {
            const cookies = document.cookie.split(";");
            for (const cookie of cookies) {
                const [cookieName, cookieValue] = cookie.trim().split("=");
                if (cookieName === name) {
                    return cookieValue;
                }
            }
            return null;
        }

        static setCookie(name: string, value: string, days: number) {
            const date = new Date();
            date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
            document.cookie = `${name}=${value};expires=${date.toUTCString()};path=/;SameSite=Lax`;
        }

        static deleteCookie(name: string) {
            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;`;
            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;domain=${window.location.hostname};`;
            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;domain=.${window.location.hostname};`;
        }
    }

    // Globale Cookie-Funktionen verfügbar machen
    (window as any).CookieManager = CookieManager;

    // UI-Logik
    document.addEventListener("DOMContentLoaded", () => {
        const banner = document.getElementById("cookie-consent-banner");
        const settingsButton = document.getElementById("cookie-settings-button");
        const closeButton = document.getElementById("close-banner");

        // Prüfe ob bereits Consent vorhanden
        if (!CookieManager.hasMediaConsent()) {
            // Zeige Banner beim ersten Besuch oder wenn noch keine Entscheidung getroffen wurde
            setTimeout(() => {
                banner?.classList.remove("translate-x-full");
            }, 1000);
        } else {
            // Zeige Settings-Button wenn bereits Consent erteilt
            settingsButton?.classList.remove("hidden");
            settingsButton?.classList.add("flex");
        }

        // Close banner without decision
        closeButton?.addEventListener("click", () => {
            banner?.classList.add("translate-x-full");
            setTimeout(() => {
                settingsButton?.classList.remove("hidden");
                settingsButton?.classList.add("flex");
            }, 300);
        });

        // Accept media
        document
            .getElementById("accept-media")
            ?.addEventListener("click", () => {
                CookieManager.setMediaConsent(true);
                banner?.classList.add("translate-x-full");
                setTimeout(() => {
                    settingsButton?.classList.remove("hidden");
                    settingsButton?.classList.add("flex");
                }, 300);
            });

        // Reject media - mit intelligenter Reload-Logik
        document
            .getElementById("reject-media")
            ?.addEventListener("click", () => {
                CookieManager.setMediaConsent(false);
                banner?.classList.add("translate-x-full");
                
                // Settings-Button nur anzeigen wenn kein Reload kommt
                const currentConsent = CookieManager.hasMediaConsent();
                const consentExists = CookieManager.getCookie("media_consent") !== null;
                
                if (!(consentExists && currentConsent === true)) {
                    // Kein Reload - zeige Settings-Button
                    setTimeout(() => {
                        settingsButton?.classList.remove("hidden");
                        settingsButton?.classList.add("flex");
                    }, 300);
                }
            });

        // Settings button
        settingsButton?.addEventListener("click", () => {
            banner?.classList.remove("translate-x-full");
            settingsButton.classList.add("hidden");
            settingsButton.classList.remove("flex");
        });
    });
</script>
